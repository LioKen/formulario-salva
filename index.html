<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario de solicitudes</title>

  <!-- Preload y estilos -->
  <link rel="preload" href="normalize.css" as="style">
  <link rel="stylesheet" href="normalize.css">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto&display=swap" rel="stylesheet">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Krub:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
  
  <link rel="preload" href="style1.css" as="style">
  <link rel="stylesheet" href="style1.css">
</head>
<body>
  <header class="header">
    <div class="header__logo">
      <a href="index.html">
        <svg width="131" height="44" viewBox="0 0 131 44" fill="none" xmlns="http://www.w3.org/2000/svg">
          <!-- Aquí van los paths de tu logo -->
        </svg>
      </a>
    </div>
    <div class="header__icono">
      <a href="index.html">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="40" height="40" viewBox="0 0 24 24" stroke-width="2" stroke="#005286" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M5 12l-2 0l9 -9l9 9l-2 0" />
          <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
          <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
        </svg>
      </a>
    </div>
  </header>

  <main>
    <section>
      <!-- Formulario -->
      <form id="miFormulario" class="formulario">
        <!-- Encabezado del formulario con ícono y color destacado -->
        <div class="form-header">
          <span class="header-icon">📝</span>
          <h2>Formulario de Solicitudes</h2>
        </div>

        <div class="contenedor-campos">
          <!-- DESCRIPCION (autocompletable con validación) -->
          <div class="campo">
            <label>DESCRIPCION</label>
            <div class="autocomplete-container">
              <input type="text" id="descripcionInput" name="descripcion" class="input-text" placeholder="Selecciona o escribe la descripción" autocomplete="off" required>
              <ul id="descripcionSuggestions" class="suggestions-list"></ul>
            </div>
          </div>

          <!-- UND DE MEDIDA (autocompletable con validación) -->
          <div class="campo">
            <label>UND DE MEDIDA</label>
            <div class="autocomplete-container">
              <input type="text" id="und_de_medidaInput" name="und_de_medida" class="input-text" placeholder="Selecciona o escribe la unidad" autocomplete="off" required>
              <ul id="und_de_medidaSuggestions" class="suggestions-list"></ul>
            </div>
          </div>

          <!-- CANTIDAD -->
          <div class="campo">
            <label>CANTIDAD</label>
            <input name="cantidad" class="input-text" type="number" min="0" placeholder="Ingresa la cantidad" required>
          </div>

          <!-- TIPO DE PEDIDO (autocompletable con validación) -->
          <div class="campo">
            <label>TIPO DE PEDIDO</label>
            <div class="autocomplete-container">
              <input type="text" id="tipo_de_pedidoInput" name="tipo_de_pedido" class="input-text" placeholder="Selecciona o escribe el tipo de pedido" autocomplete="off" required>
              <ul id="tipo_de_pedidoSuggestions" class="suggestions-list"></ul>
            </div>
          </div>

          <!-- OT -->
          <div class="campo">
            <label>OT</label>
            <input name="ot" class="input-text" type="text" placeholder="Ingresa la OT" required>
          </div>

          <!-- DETALLE UBICACION EN MAQUINA -->
          <div class="campo">
            <label>DETALLE UBICACION EN MAQUINA</label>
            <input name="detalle_ubicacion_maquina" class="input-text" type="text" placeholder="Ingresa el detalle de la ubicación" required>
          </div>

          <!-- MAQUINA (autocompletable con validación) -->
          <div class="campo">
            <label>MAQUINA</label>
            <div class="autocomplete-container">
              <input type="text" id="maquinaInput" name="maquina" class="input-text" placeholder="Selecciona o escribe la máquina" autocomplete="off" required>
              <ul id="maquinaSuggestions" class="suggestions-list"></ul>
            </div>
          </div>

          <!-- SOLICITANTE (autocompletable con validación) -->
          <div class="campo">
            <label>SOLICITANTE</label>
            <div class="autocomplete-container">
              <input type="text" id="solicitanteInput" name="solicitante" class="input-text" placeholder="Selecciona o escribe el solicitante" autocomplete="off" required>
              <ul id="solicitanteSuggestions" class="suggestions-list"></ul>
            </div>
          </div>
        </div>

        <div class="alinear-derecha flex">
          <input class="boton wm-sm-100" type="submit" value="Enviar">
        </div>

        <!-- Spinner para indicar espera durante el envío -->
        <div id="spinner" style="display: none; text-align: center; margin-top: 10px;">
          <svg class="spinner" viewBox="0 0 50 50">
            <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
          </svg>
        </div>

        <!-- Mensaje de confirmación de envío -->
        <div id="confirmationMessage" style="display: none;"></div>
      </form>
    </section>
  </main>

  <footer>
    Por favor, si tiene inconvenientes, comuníquese con ********
  </footer>

  <!-- Scripts -->
  <script>
    // Variables para almacenar datos de cada campo (se cargarán desde el archivo JSON)
    let datosDescripcion = [];
    let datosUndDeMedida = [];
    let datosTipoDePedido = [];
    let datosMaquina = [];
    let datosSolicitante = [];

    // Cargar datos desde opciones.json
    fetch('opciones.json')
      .then(response => response.json())
      .then(data => {
        datosDescripcion = data.descripcion || [];
        datosUndDeMedida = data.und_de_medida || [];
        datosTipoDePedido = data.tipo_de_pedido || [];
        datosMaquina = data.maquina || [];
        datosSolicitante = data.solicitante || [];
      })
      .catch(error => console.error('Error al cargar el archivo JSON:', error));

    // Función para filtrar y mostrar sugerencias
    function mostrarSugerencias(inputElement, suggestionsElement, datos) {
      const query = inputElement.value.toLowerCase();
      suggestionsElement.innerHTML = '';
      const filtrados = datos.filter(item => item.toLowerCase().includes(query));
      filtrados.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        li.addEventListener('click', () => {
          inputElement.value = item;
          suggestionsElement.innerHTML = '';
        });
        suggestionsElement.appendChild(li);
      });
    }

    // Asignar eventos de autocompletado para cada campo
    const descripcionInput = document.getElementById('descripcionInput');
    const descripcionSuggestions = document.getElementById('descripcionSuggestions');
    descripcionInput.addEventListener('input', function() {
      mostrarSugerencias(descripcionInput, descripcionSuggestions, datosDescripcion);
    });

    const undDeMedidaInput = document.getElementById('und_de_medidaInput');
    const undDeMedidaSuggestions = document.getElementById('und_de_medidaSuggestions');
    undDeMedidaInput.addEventListener('input', function() {
      mostrarSugerencias(undDeMedidaInput, undDeMedidaSuggestions, datosUndDeMedida);
    });

    const tipoDePedidoInput = document.getElementById('tipo_de_pedidoInput');
    const tipoDePedidoSuggestions = document.getElementById('tipo_de_pedidoSuggestions');
    tipoDePedidoInput.addEventListener('input', function() {
      mostrarSugerencias(tipoDePedidoInput, tipoDePedidoSuggestions, datosTipoDePedido);
    });

    const maquinaInput = document.getElementById('maquinaInput');
    const maquinaSuggestions = document.getElementById('maquinaSuggestions');
    maquinaInput.addEventListener('input', function() {
      mostrarSugerencias(maquinaInput, maquinaSuggestions, datosMaquina);
    });

    const solicitanteInput = document.getElementById('solicitanteInput');
    const solicitanteSuggestions = document.getElementById('solicitanteSuggestions');
    solicitanteInput.addEventListener('input', function() {
      mostrarSugerencias(solicitanteInput, solicitanteSuggestions, datosSolicitante);
    });

    // Cerrar sugerencias al hacer clic fuera del contenedor
    document.addEventListener('click', function(e) {
      document.querySelectorAll('.autocomplete-container').forEach(container => {
        if (!container.contains(e.target)) {
          container.querySelectorAll('.suggestions-list').forEach(list => list.innerHTML = '');
        }
      });
    });

    // Validar que el valor ingresado sea de la lista antes de enviar
    document.getElementById('miFormulario').addEventListener('submit', function(e) {
      // Validar DESCRIPCION
      if (!datosDescripcion.includes(descripcionInput.value)) {
        e.preventDefault();
        alert('Por favor, selecciona un valor válido para DESCRIPCION.');
        descripcionInput.focus();
        return;
      }
      // Validar UND DE MEDIDA
      if (!datosUndDeMedida.includes(undDeMedidaInput.value)) {
        e.preventDefault();
        alert('Por favor, selecciona un valor válido para UND DE MEDIDA.');
        undDeMedidaInput.focus();
        return;
      }
      // Validar TIPO DE PEDIDO
      if (!datosTipoDePedido.includes(tipoDePedidoInput.value)) {
        e.preventDefault();
        alert('Por favor, selecciona un valor válido para TIPO DE PEDIDO.');
        tipoDePedidoInput.focus();
        return;
      }
      // Validar MAQUINA
      if (!datosMaquina.includes(maquinaInput.value)) {
        e.preventDefault();
        alert('Por favor, selecciona un valor válido para MAQUINA.');
        maquinaInput.focus();
        return;
      }
      // Validar SOLICITANTE
      if (!datosSolicitante.includes(solicitanteInput.value)) {
        e.preventDefault();
        alert('Por favor, selecciona un valor válido para SOLICITANTE.');
        solicitanteInput.focus();
        return;
      }

      // Mostrar spinner y enviar datos a Google Sheets
      var form = this;
      var spinner = document.getElementById('spinner');
      var confirmationMessage = document.getElementById('confirmationMessage');
      spinner.style.display = 'block';
      confirmationMessage.style.display = 'none';

      var data = {
        descripcion: descripcionInput.value,
        und_de_medida: undDeMedidaInput.value,
        cantidad: form.querySelector('input[name="cantidad"]').value,
        tipo_de_pedido: tipoDePedidoInput.value,
        ot: form.querySelector('input[name="ot"]').value,
        detalle_ubicacion_maquina: form.querySelector('input[name="detalle_ubicacion_maquina"]').value,
        maquina: maquinaInput.value,
        solicitante: solicitanteInput.value
      };

      const scriptURL = 'https://script.google.com/macros/s/AKfycbwKnAzxJtVAkx7tED6OcFXWXfFQMFr7hpvW5uCd4jI6npEfkXo4fD2Rb4Gjiir55Xoc/exec';
      
      fetch(scriptURL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(response => {
        spinner.style.display = 'none';
        confirmationMessage.textContent = 'Su solicitud ha sido enviada correctamente.';
        confirmationMessage.style.display = 'block';
        form.reset();
      })
      .catch(error => {
        spinner.style.display = 'none';
        confirmationMessage.textContent = 'Error al enviar datos, por favor intenta de nuevo.';
        confirmationMessage.style.display = 'block';
        console.error('Error!', error.message);
      });
    });
  </script>
</body>
</html>

